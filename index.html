<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Navigator PWA</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="device-features.js" ></script>
    <link rel="manifest" href="/manifest.json">
    <style>
        #map { height: 100vh; width: 100vw; }
        
        /* UI OVERLAY STYLES */
        .ui-container {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
            width: 100%;
            pointer-events: none;
        }
        
        /* TOP SEARCH BAR */
        .top-search-bar {
            background-color: white;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }
        .top-search-bar input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .top-search-bar button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* FLOATING ACTION BUTTONS (FABs) */
        .fab-group {
            position: fixed;
            right: 15px;
            bottom: 30px;
            display: flex;
            flex-direction: column-reverse;
            gap: 15px;
            pointer-events: auto;
            z-index:1001;
          }
        .fab-group button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        #gps-button { background-color: #007bff; }
        #menu-button { background-color: #28a745; }
        #crud-button { background-color: #dc3545; }

        /*  (MENU) */
        #side-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            padding: 20px;
            pointer-events: auto;
            z-index: 1010;
        }
        #side-panel.open {
            transform: translateX(0);
        }
        .panel-option {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 18px;
        }
        .panel-option:hover {
            background-color: #f8f9fa;
        }
        
        /* Style for the direction arrow marker */
        .direction-arrow-icon {
            font-size: 36px;
            color: #28a745; 
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            /* Important: Rotation needs a transform-origin of center */
            transform-origin: center center; 
        }
        
        .destination-pin {
            color: #f10000; 
            font-size: 30px;
        }

        
        .fun-spot-icon .fun-spot-pin {
            font-size: 30px;
            color: #32CD32;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.4); 
            
        }

        #shake-button { 
         background-color: #FF9800; 
        }

        #clear-all-button { 
            background-color: #9C27B0; 
        }   
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="ui-container">
        <div class="top-search-bar">
            <input type="text" id="class-search-input" placeholder="Search Class Code (e.g., Lab G1.2)">
            <button onclick="handleRouteSearch()">Route</button>
        </div>
    </div>

    <div class="fab-group">
        <button id="crud-button" title="Manage Classes" onclick="openClassManager()">
            <i class="material-icons">add</i>
        </button>
        <button id="menu-button" title="Open Menu" onclick="togglePanel()">
            <i class="material-icons">menu</i>
        </button>
        <button id="shake-button" title="Enable Shake Detection" onclick="toggleShakeDetection()" style="background-color: #FF9800;">
            <i class="material-icons">vibration</i>
        </button>
     
        <button id="clear-all-button" title="Clear All Markers" onclick="clearAllMarkers()" style="background-color: #9C27B0;">
            <i class="material-icons">clear_all</i>
        </button>
        <button id="gps-button" title="My Location" onclick="handleGPSCenter()">
            <i class="material-icons">my_location</i>
        </button>
    </div>

    <div id="side-panel">
        <button onclick="togglePanel()" style="float:right; border:none; background:none; font-size: 24px;">&times;</button>
        <h2>Menu</h2>
        <h4>My Saved Classes</h4>
        <div id="user-classes-list-container">
            <p style="padding-left: 10px; font-style: italic; color: #777;"></p>
        </div>
        <div class="panel-option" onclick="togglePanel(); vibrateAndShowFunSpots('menu');">Fun Spots ðŸ¥³</div>
        
    </div>

    <div id="class-manager-modal" style="
        display: none; /* Controlled by open/closeClassManager() */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    ">
        <div style="
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
        ">
            <button onclick="closeClassManager()" style="float:right; border:none; background:none; font-size: 24px; cursor: pointer;">&times;</button>
            <h2>Manage My Classes</h2>
            
            <form id="add-class-form" style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
                <h4>Add New Class</h4>
                <input type="text" id="new-class-code" placeholder="Class Code (e.g., LAB G1.2)" required style="width: 100%; padding: 8px; margin: 5px 0;">
                <input type="text" id="new-class-name" placeholder="Friendly Name (e.g., Mobile App Dev)" style="width: 100%; padding: 8px; margin: 5px 0;">
                <button type="submit" style="background-color: #28a745; color: white; border: none; padding: 10px; width: 100%; margin-top: 10px; border-radius: 4px; cursor: pointer;">Add Class</button>
            </form>
            
            <h4>Saved Classes</h4>
            <div id="class-list-container">
                
            </div>
        </div>
    </div>
    

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script src="class manager.js"></script>

    <script>
        
        const rawRoomsData = [
            
            { "building": "UTM", "floor": "2", "roomCode": "B1.07", "coords": { "lat": -20.17683, "lng": 57.46730 } },
            { "building": "UTM", "floor": "2", "roomCode": "B1.06", "coords": { "lat": -20.17683, "lng": 57.46730 } },
            { "building": "UTM", "floor": "2", "roomCode": "B1.05", "coords": { "lat": -20.17683, "lng": 57.46730 } },
            { "building": "UTM", "floor": "2", "roomCode": "B1.03", "coords": { "lat": -20.17683, "lng": 57.46730 } },
            { "building": "UTM", "floor": "2", "roomCode": "B1.101", "coords": { "lat": -20.17683, "lng": 57.46730 } },
            { "building": "UTM", "floor": "1", "roomCode": "C0.01", "coords": { "lat": -20.17683, "lng": 57.46730 } },
            { "building": "UTM", "floor": "1", "roomCode": "D0.05", "coords": { "lat": -20.17683, "lng": 57.46730 } },
            { "building": "UTM", "floor": "1", "roomCode": "D0.02", "coords": { "lat": -20.17683, "lng": 57.46730 } },
            { "building": "UTM", "floor": "1", "roomCode": "D0.01", "coords": { "lat": -20.17683, "lng": 57.46730 } },
            { "building": "SITE", "floor": "1", "roomCode": "Lab G1.01", "coords": { "lat": -20.17741, "lng": 57.46761 } },
            { "building": "SITE", "floor": "2", "roomCode": "Lab G1.3", "coords": { "lat": -20.17741, "lng": 57.46761 } },
            { "building": "SITE", "floor": "2", "roomCode": "Lab G1.1", "coords": { "lat": -20.17741, "lng": 57.46761 } },
            { "building": "SITE", "floor": "2", "roomCode": "Lab G1.5", "coords": { "lat": -20.17741, "lng": 57.46761 } },
            { "building": "SITE", "floor": "2", "roomCode": "Lab G1.2", "coords": { "lat": -20.17741, "lng": 57.46761 } },
            { "building": "SITE", "floor": "2", "roomCode": "Lab G1.5", "coords": { "lat": -20.17741, "lng": 57.46761 } },
            { "building": "SITE", "floor": "3", "roomCode": "Administration", "coords": { "lat": -20.17741, "lng": 57.46761 } },
            { "building": "BPML", "floor": "0", "roomCode": "BPML 0.3", Â "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "0", "roomCode": "BPML 0.02", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "0", "roomCode": "BPML 0.01", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "0", "roomCode": "BPML 0.12", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "0", "roomCode": "BPML 0.11", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "0", "roomCode": "BPML Business Incubator", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "0", "roomCode": "BPML 0.09", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "0", "roomCode": "BPML 0.08", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "0", "roomCode": "BPML 0.04", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "0", "roomCode": "BPML 0.05", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.09", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.10", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.11", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.04", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.12", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.13", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.14", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.01", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.02", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.03", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.05", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.06", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.07", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "1", "roomCode": "BPML 1.08", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.09", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.10", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.11", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.13", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.14", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.02", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.03", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.04", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.05", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.06", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.07", "coords": { "lat": -20.17747, "lng": 57.46761 } },
            { "building": "BPML", "floor": "2", "roomCode": "BPML 2.08", "coords": { "lat": -20.17747, "lng": 57.46761 } }
        ];

        window.roomLookup = {};
        rawRoomsData.forEach(room => {
            if (room.coords.x && room.coords.y) {
            room.coords.lat = room.coords.x;
            room.coords.lng = room.coords.y;
            delete room.coords.x;
            delete room.coords.y;
            }
            const upperCaseCode = room.roomCode.trim().toUpperCase(); 
            roomLookup[upperCaseCode] = room;
        });

        const funSpotsData = [
            { name: "Student Common (Games)", lat: -20.177465798857607, lng: 57.46780282802911, icon: 'sports_esports', color: '#1E90FF' }, // Dodger Blue
            { name: "Basketball Court", lat: -20.17668, lng: 57.46817, icon: 'sports_basketball', color: '#FFD700' },
            { name: "Volleyball Playground", lat: -20.176451903978297, lng: 57.46799122545888, icon: 'sports_volleyball', color: '#32CD32' }, // Lime Green
            { name: "Football Field", lat: -20.176958956225874, lng: 57.46811417371047, icon: 'sports_soccer', color: '#FF4500' }, // Orange Red
        ];

        let funSpotMarkers = [];

        
        //  Map Initialization 
        const UNIVERSITY_LAT = -20.17683;
        const UNIVERSITY_LNG = 57.46730;

        const map = L.map('map', {
            center: [UNIVERSITY_LAT, UNIVERSITY_LNG],
            zoom: 17
        });

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri'
        }).addTo(map);

        // GPS Tracking and State Variables 
        let currentGPSMarker = null;
        let currentGPSLatlng = null; 
        let destinationPin = null;
        let destinationLatlng = null;
        let directionArrowMarker = null;
        let currentDestiantionInfo = null;
        const ARROW_PIXEL_OFFSET = 30; 

        function startLiveLocation() {
            map.locate({ 
                watch: true, 
                maxZoom: 18,
                enableHighAccuracy: true 
            });
        }
        
        // Function to calculate bearing between two points
        function calculateBearing(startLatlng, endLatlng) {
            const lat1 = startLatlng.lat * (Math.PI / 180);
            const lat2 = endLatlng.lat * (Math.PI / 180);
            const dLon = (endLatlng.lng - startLatlng.lng) * (Math.PI / 180);

            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            let brng = Math.atan2(y, x) * (180 / Math.PI);

            return (brng + 360) % 360;
        }

        


        // Event listener for when the browser finds the user's location
        map.on('locationfound', (e) => {
            currentGPSLatlng = e.latlng;
            
            
            if (currentGPSMarker) {
                currentGPSMarker.setLatLng(e.latlng);
            } else {
                currentGPSMarker = L.circleMarker(e.latlng, {
                    radius: 8,
                    color: 'blue',
                    fillColor: '#0066FF',
                    fillOpacity: 0.8
                }).addTo(map).bindPopup("You Are Here (Live GPS)");
            }

            
            if (destinationLatlng) {
                const bearingToDest = calculateBearing(currentGPSLatlng, destinationLatlng);
                
                
                //  Get the user's current location in screen pixel coordinates
                const userPixelPoint = map.latLngToLayerPoint(currentGPSLatlng);

                //  Calculate the arrow's new pixel position based on the bearing and fixed pixel offset
                // Note: The bearing is measured clockwise from North (0 degrees).
                // We convert bearing (degrees) to radians for Math.sin/cos.
                const angleRad = (bearingToDest - 90) * (Math.PI / 180); // Adjust -90 because Math.cos(0) is right (East)
                
                const arrowPixelX = userPixelPoint.x + ARROW_PIXEL_OFFSET * Math.cos(angleRad);
                const arrowPixelY = userPixelPoint.y + ARROW_PIXEL_OFFSET * Math.sin(angleRad);
                
                const arrowPixelPoint = L.point(arrowPixelX, arrowPixelY);

                // 3. Convert the new pixel position back to LatLng coordinates
                const arrowLatlng = map.layerPointToLatLng(arrowPixelPoint);
               

            


                if (directionArrowMarker) {
                    // Update position to the new calculated LatLng
                    directionArrowMarker.setLatLng(arrowLatlng);
                    // Update rotation (The icon points UP (0 deg), so we rotate by the calculated bearing)
                    directionArrowMarker._icon.style.transform = `translate(-50%, -50%) rotate(${bearingToDest}deg)`;
                } else {
                    // Create the arrow marker the first time
                    const arrowIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<i class="material-icons direction-arrow-icon" style="transform: rotate(${bearingToDest}deg);">navigation</i>`, 
                        iconSize: [36, 36],
                        iconAnchor: [18, 18] 
                    });
                    
                    directionArrowMarker = L.marker(arrowLatlng, { icon: arrowIcon }).addTo(map);
                }
            }
        });

        map.on('locationerror', (e) => {
            alert(`Location access failed: ${e.message}. Please ensure GPS is enabled.`);
        });


         
        function clearAllMarkers() {
            console.log("Clearing all markers from map...");
            
            clearDestination();
            clearFunSpotMarkers();
            
            
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]); 
            }
            
            // 5. Show success notification
            if (currentGPSLatlng) {
                const notification = L.popup()
                    .setLatLng(currentGPSLatlng)
                    .setContent("âœ… All markers cleared from map")
                    .openOn(map);
                
                setTimeout(() => map.closePopup(notification), 2000);
            } else {
                alert("All markers cleared!");
            }
            
            console.log("All markers cleared successfully");
        }


        // Function to handle GPS button click
        function handleGPSCenter() {
            if (currentGPSLatlng) {
                // Only center the map when the button is explicitly pressed
                map.setView(currentGPSLatlng, map.getZoom()); 
            } else {
                startLiveLocation();
            }
        }

        // Function to handle the search bar input and initiate navigation
        function handleRouteSearch() {
            const classCode = document.getElementById('class-search-input').value.trim().toUpperCase();
            if (classCode) {
                showDestination(classCode);
            } else {
                clearDestination();
                alert("Please enter a class code to start navigation.");
            }
        }

        // Function to toggle the side panel open/closed
        function togglePanel() {
            document.getElementById('side-panel').classList.toggle('open');
        }
        
        // Function to clear destination state
        function clearDestination() {
            if (destinationPin) {
                map.removeLayer(destinationPin);
                destinationPin = null;
            }
            if (directionArrowMarker) {
                map.removeLayer(directionArrowMarker);
                directionArrowMarker = null;
            }
            destinationLatlng = null;
            currentDestinationInfo = null;

            stopProximityCheck();
        }

        function showDestination(roomCode) {
            clearDestination();
            
            const destination = roomLookup[roomCode];  
            
            if (!destination) {
                alert(`Room code ${roomCode} not found in data.`);
                return;
            }

            if (!currentGPSLatlng) {
                alert("Please wait for your GPS location to be found before pinning a destination (press the blue location button).");
                return;
            }

            // Store destination info globally 
            currentDestinationInfo = {
                code: destination.roomCode,
                building: destination.building,
                floor: destination.floor || "Unknown Floor"
            };

            // Destination coordinate
            const destCoords = [destination.coords.lat, destination.coords.lng];
            destinationLatlng = L.latLng(destCoords[0], destCoords[1]);
            
            //  Place the visible custom marker with floor info
            destinationPin = L.marker(destinationLatlng, {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: '<i class="material-icons destination-pin">location_on</i>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            }).addTo(map).bindPopup(
                `Destination: ${destination.roomCode}<br>` +
                `Building: ${destination.building}<br>` +
                `Floor: ${destination.floor || "N/A"}`
            ).openPopup();

            //  Re-trigger locationfound to place and orient the arrow immediately
            map.fire('locationfound', { latlng: currentGPSLatlng });

            // Adjust Map View to show both points
            const bounds = L.latLngBounds([currentGPSLatlng, destinationLatlng]);
            map.fitBounds(bounds, {
                padding: [50, 50] 
            });
            
            // Start checking proximity to destination
            startProximityCheck();
        }

        //  render classes in the side panel 
        function renderSidePanelClasses() {
            // loadClasses() is available from class-manager.js
            const classes = loadClasses(); 
            const container = document.getElementById('user-classes-list-container');
            container.innerHTML = ''; // Clear existing content

            if (classes.length === 0) {
                container.innerHTML = '<p style="padding-left: 10px; color: #555;">No classes saved. Click the red button to add one!</p>';
                return;
            }

            classes.forEach(cls => {
                const link = document.createElement('div');
                link.className = 'panel-option';
                
                // important-Set the onclick to close the panel and start navigation
                link.onclick = function() {
                    togglePanel(); // Close panel first
                    showDestination(cls.code); 
                };
                
                // Get floor information from roomLookup
                const roomInfo = roomLookup[cls.code.toUpperCase()];
                const floorInfo = roomInfo ? `Floor: ${roomInfo.floor}` : '';
                link.innerHTML = `<strong>${cls.code}</strong> ${cls.name ? `(${cls.name})` : ''}<br><small>${floorInfo}</small>`;
                container.appendChild(link);
            });
        }
        
        // Modify the existing togglePanel function 
        function togglePanel() {
            const panel = document.getElementById('side-panel');
            panel.classList.toggle('open');
            
            // Load the classes list when the panel opens
            if (panel.classList.contains('open')) {
                renderSidePanelClasses();
            }
        }
        
        
    
        function openClassManager() {
            document.getElementById('class-manager-modal').style.display = 'flex';
            renderClassList(); 
        }

        function closeClassManager() {
            document.getElementById('class-manager-modal').style.display = 'none';
            renderSidePanelClasses();
        }

         // Function to refresh both class displays
        function refreshAllClassDisplays() {
            renderClassList(); 
            renderSidePanelClasses(); 
        }
            window.refreshAllClassDisplays = refreshAllClassDisplays;

        
        function clearFunSpotMarkers() {
            funSpotMarkers.forEach(marker => map.removeLayer(marker));
            funSpotMarkers = [];
        }
        

        function showFunSpots() {
            console.log("showFunSpots called"); // Check if function is being called
            console.log("clearFunSpotMarkers exists?", typeof clearFunSpotMarkers); 
            console.log("funSpotMarkers exists?", typeof funSpotMarkers); 
            clearDestination();
            clearFunSpotMarkers();
        

            const allLatLangs = [];

            funSpotsData.forEach(spot => {
            const coords = L.latLng(spot.lat, spot.lng);
            allLatLangs.push(coords);
        
           
            const funSpotIcon = L.divIcon({
                className: 'fun-spot-icon',
                // Uses the color and icon from the funSpotsData array
                html: `<i class="material-icons fun-spot-pin" style="color: ${spot.color};">${spot.icon}</i>`, 
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });

                // Place the marker on the map
                const marker = L.marker(coords, { icon: funSpotIcon })
                    .addTo(map)
                    .bindPopup(`<b>${spot.name}</b>`)
                    .openPopup();
                    
                funSpotMarkers.push(marker);
            });

            // Adjust Map View to show all spots (and the current GPS location if found)
            if (allLatLangs.length > 0) {
                if (currentGPSLatlng) {
                    allLatLangs.push(currentGPSLatlng);
                }
                const bounds = L.latLngBounds(allLatLangs);
                map.fitBounds(bounds, {
                    padding: [50, 50] 
                });
            }
        }

              

        // Global variables for distance tracking
        let destinationCheckInterval = null;
        const DESTINATION_PROXIMITY_METERS = 20; // 20 meters, not to put above 40 or 30

        /**
         * Calculate distance between two coordinates in meters
         * Using Haversine formula
         */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Start checking proximity to destination
        function startProximityCheck() {
            // Clear any existing interval
            if (destinationCheckInterval) {
                clearInterval(destinationCheckInterval);
                destinationCheckInterval = null;
            }
            
            // Only start if we have both current location and destination
            if (!currentGPSLatlng || !destinationLatlng) {
                return;
            }
            
            // Check every 2 seconds
            destinationCheckInterval = setInterval(() => {
                if (!currentGPSLatlng || !destinationLatlng) {
                    clearInterval(destinationCheckInterval);
                    destinationCheckInterval = null;
                    return;
                }
                
                const distance = calculateDistance(
                    currentGPSLatlng.lat, currentGPSLatlng.lng,
                    destinationLatlng.lat, destinationLatlng.lng
                );
                
                // If within 20 meters, vibrate and show alert
                if (distance <= DESTINATION_PROXIMITY_METERS) {
                    if (navigator.vibrate) {
                        navigator.vibrate([80, 40, 80]); //pattern
                    }
                    
                    
                    // Show notification
                if (destinationPin && currentDestinationInfo) {
                    destinationPin.bindPopup(
                        `ðŸŽ¯ Destination reached!<br>` +
                        `Class: ${currentDestinationInfo.code}<br>` +
                        `Building: ${currentDestinationInfo.building}<br>` +
                        `Floor: ${currentDestinationInfo.floor}<br>` +
                        `Distance: ${Math.round(distance)}m`
                    ).openPopup();
                }
                    
                    // Clear the interval since we've reached destination
                    clearInterval(destinationCheckInterval);
                    destinationCheckInterval = null;
                }
                
                
            if (destinationPin && currentDestinationInfo) {
                destinationPin.setPopupContent(
                    `Destination: ${currentDestinationInfo.code}<br>` +
                    `Building: ${currentDestinationInfo.building}<br>` +
                    `Floor: ${currentDestinationInfo.floor}<br>` +
                    `Distance: ${Math.round(distance)}m`
                );
            }
            },2000);
        
        }
    

        // stop proximity checking
        function stopProximityCheck() {
            if (destinationCheckInterval) {
                clearInterval(destinationCheckInterval);
                destinationCheckInterval = null;
            }
        }

        // Initialize shake-to-show-funspots feature
        async function initShakeDetection() {
            try {
               
                // Check if device orientation is supported
                if (!("DeviceOrientationEvent" in window)) {
                    console.log("Device orientation not supported");
                    return;
                }
                
                // Request permission for iOS 13+
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission !== 'granted') {
                            console.log("Device orientation permission denied");
                            return;
                        }
                    } catch (error) {
                        console.log("Device orientation permission error:", error);
                        return;
                    }
                }
                
                // Simple shake detection variables
                let lastShakeTime = 0;
                const SHAKE_THRESHOLD = 15; // Degrees* change if too sensitive
                const SHAKE_COOLDOWN = 2000; // 2 seconds
                
                // Handle device orientation
                window.addEventListener('deviceorientation', (event) => {
                    const now = Date.now();
                    
                    // Check cooldown
                    if (now - lastShakeTime < SHAKE_COOLDOWN) {
                        return;
                    }
                    
                    const { beta, gamma } = event;
                    
                    // Calculate movement magnitude
                    const betaChange = Math.abs(beta - (window.lastBeta || beta));
                    const gammaChange = Math.abs(gamma - (window.lastGamma || gamma));
                    
                    window.lastBeta = beta;
                    window.lastGamma = gamma;
                    
                    // Check if shake detected
                    if ((betaChange > SHAKE_THRESHOLD || gammaChange > SHAKE_THRESHOLD) && 
                        (betaChange + gammaChange) > SHAKE_THRESHOLD * 1.5) {
                        
                        lastShakeTime = now;
                        
                        // Vibrate to acknowledge shake
                        if (navigator.vibrate) {
                            navigator.vibrate([60, 40, 60, 40, 60]); // Warning pattern
                        }
                        
                        // Show fun spots
                        vibrateAndShowFunSpots('shake');
                        
                        const notification = L.popup()
                            .setLatLng(currentGPSLatlng || [UNIVERSITY_LAT, UNIVERSITY_LNG])
                            .setContent("ðŸŽ‰ Shake detected! Showing Fun Spots!")
                            .openOn(map);
                        
                        // Auto-close notification after 3 seconds
                        setTimeout(() => {
                            map.closePopup(notification);
                        }, 3000);
                    }
                });
                
                console.log("Shake detection enabled");
                
            } catch (error) {
                console.error("Failed to initialize shake detection:", error);
            }
        }


                //Vibrate and show Fun Spots (used for both menu click and shake)
        function vibrateAndShowFunSpots(source = 'click') {
            console.log("ðŸŽ¯ Vibrating and showing Fun Spots...");
            
            // Vibrate with a fun pattern
            if (navigator.vibrate) {
                navigator.vibrate([50, 30, 100, 30, 200]);
                console.log("ðŸ“³ Vibration triggered");
            } else {
                console.log("âš ï¸ Vibration not supported");
            }
            
            //  Show the Fun Spots
            showFunSpots();
            
            // Show a quick success message
            if (currentGPSLatlng) {
                const notification = L.popup()
                    .setLatLng(currentGPSLatlng)
                    .setContent("ðŸŽ‰ Showing Fun Spots! ðŸ¥³")
                    .openOn(map);
                
                // Auto-close after 2 seconds
                setTimeout(() => {
                    map.closePopup(notification);
                }, 2000);
            }
        }


        // Update clearDestination to stop proximity checking
        function clearDestination() {
            if (destinationPin) {
                map.removeLayer(destinationPin);
                destinationPin = null;
            }
            if (directionArrowMarker) {
                map.removeLayer(directionArrowMarker);
                directionArrowMarker = null;
            }
            destinationLatlng = null;
            
            // Stop proximity checking
            stopProximityCheck();
        }

        setTimeout(() => {
            if (confirm("Enable shake detection? Shake your device to quickly access Fun Spots!")) {
                toggleShakeDetection();
            }
        }, 3000);

        let shakeDetectionEnabled = false;

        async function toggleShakeDetection() {
            if (!shakeDetectionEnabled) {
                // Enable shake detection
                const success = await initShakeDetection();
                if (success) {
                    shakeDetectionEnabled = true;
                    document.getElementById('shake-button').style.backgroundColor = '#4CAF50';
                    document.getElementById('shake-button').innerHTML = '<i class="material-icons">check</i>';
                    alert("Shake detection enabled! Shake your device to show Fun Spots.");
                }
            } else {
                // Disable shake detection
                shakeDetectionEnabled = false;
                document.getElementById('shake-button').style.backgroundColor = '#FF9800';
                document.getElementById('shake-button').innerHTML = '<i class="material-icons">vibration</i>';
                alert("Shake detection disabled.");
            }
        }

        
        // Initial Call ---
        startLiveLocation();
        renderSidePanelClasses();
        
    </script>

    

</body>
</html>
